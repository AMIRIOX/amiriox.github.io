<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>CSAPP3e第七章(链接) | Amiriox's Storage
</title>


  <meta name="description" content="世界再大 不过是些代价">



  <link rel="icon" href="/images/favicon-32x32.ico">



<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lora:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="/css/style.css">



<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true,
      tags: 'ams'
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Amiriox's Storage" type="application/atom+xml">
</head>
<body>
  <div class="newspaper-wrapper">
    <header class="newspaper-header">
  <div class="header-top">
    <div class="header-edition">Morning Edition</div>
    <div class="header-date">星期一, 二月 2, 2026</div>
    <button class="theme-toggle" aria-label="Toggle dark mode">
      <span class="toggle-sun">☀</span>
      <span class="toggle-moon">☾</span>
    </button>
  </div>
  
  <div class="masthead">
    <h1 class="newspaper-title">
      <a href="/">折鸦夜明け前</a>
    </h1>
    <p class="newspaper-motto">我们的同志在困难的时候，要看到成绩，要看到光明，要提高我们的勇气。</p>
  </div>
  
  <nav class="newspaper-nav">
    <div class="nav-divider"></div>
    <ul class="nav-menu">
      
        <li class="nav-item">
          <a href="/" class="nav-link">Home</a>
        </li>
      
        <li class="nav-item">
          <a href="/archives" class="nav-link">Archives</a>
        </li>
      
        <li class="nav-item">
          <a href="/categories" class="nav-link">Categories</a>
        </li>
      
        <li class="nav-item">
          <a href="/tags" class="nav-link">Tags</a>
        </li>
      
        <li class="nav-item">
          <a href="/about" class="nav-link">About</a>
        </li>
      
    </ul>
    <div class="nav-divider"></div>
  </nav>
</header>

    
    <main class="newspaper-content">
      
<div class="post-container">
  <article class="post-full">
    <header class="post-header">
      <div class="post-meta-top">
        
          <span class="post-category">组成原理</span>
        
        <time datetime="2025-02-19T08:28:39.000Z" class="post-date">
          星期三, 二月 19, 2025</time>
      </div>
      
      <h1 class="post-title">CSAPP3e第七章(链接)</h1>
      
      
      
      <div class="post-byline">
        
          <span class="post-author">By 折鸦夜明け前</span>
        
        
          <span class="post-updated">Updated 十二月 31, 2025</span>
        
      </div>
    </header>
    
    <div class="post-divider"></div>
    
    <div class="post-content">
      <h1 id="链接第七章-all">链接(第七章 ALL)</h1>
<p>这章内容很短, 就是书中和 15213 都有意隐去了很多细节,
自己去理解思考这些细节会很麻烦</p>
<p>另外 section 的翻译易引起歧义, 这里不作翻译</p>
<h2 id="静态链接">静态链接:</h2>
<p>静态链接包括两个阶段, 符号解析和重定位:</p>
<h3 id="符号解析">符号解析</h3>
<p>符号解析是要把每一个符号引用与符号定义联系起来</p>
<p>首先要理解可重定向文件的各个 section</p>
<span id="more"></span>
<table style="width:100%;">
<colgroup>
<col style="width: 12%" />
<col style="width: 46%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">名称</th>
<th style="text-align: center;">意义</th>
<th style="text-align: center;">举例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">ELF Header</td>
<td style="text-align: center;">描述 ELF 格式文件的各个 Section
信息</td>
<td style="text-align: center;">开始 16
字节描述了生成该文件的系统的大小和字节顺序,
剩下的描述目标文件类型/机器类型等</td>
</tr>
<tr>
<td style="text-align: center;"><code>.text</code></td>
<td style="text-align: center;">代码段, 已编译程序的机器代码</td>
<td
style="text-align: center;"><code>E8 78 56 34 12</code> (<code>callq 0x12345678</code>)</td>
</tr>
<tr>
<td style="text-align: center;"><code>.rodata</code></td>
<td style="text-align: center;">只读数据</td>
<td style="text-align: center;"><code>printf("%d", a)</code> 中的
<code>"%d"</code>, switch 的跳转表</td>
</tr>
<tr>
<td style="text-align: center;"><code>.data</code></td>
<td style="text-align: center;">已初始化的全局和静态变量</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><code>.bss</code>*</td>
<td style="text-align: center;">未初始化的或初始化为 0
的全局和静态变量</td>
<td
style="text-align: center;"><code>static int bss = 0; int arr[N]; signed main() &#123;&#125;</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>.symtab</code></td>
<td style="text-align: center;">符号表, 定义和引用的符号信息</td>
<td style="text-align: center;">任意符号</td>
</tr>
<tr>
<td style="text-align: center;"><code>.rel.text</code></td>
<td style="text-align: center;">代码段符号的重定位条目(见下文)</td>
<td style="text-align: center;"><code>void func();</code> 中
<code>R_X86_64_PC32 func</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>.rel.data</code></td>
<td style="text-align: center;">数据段符号的重定位条目(见下文)</td>
<td style="text-align: center;"><code>int arr[N];</code> 中
<code>R_X86_64_32 arr</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>.debug</code></td>
<td style="text-align: center;"><code>-g</code>, 原始 C 文件</td>
<td style="text-align: center;">N/A</td>
</tr>
<tr>
<td style="text-align: center;"><code>.line</code></td>
<td style="text-align: center;">行号映射</td>
<td style="text-align: center;">N/A</td>
</tr>
<tr>
<td style="text-align: center;"><code>.strtab</code></td>
<td style="text-align: center;"><code>.symtab</code> 和
<code>.debug</code> 中的符号表, Section Header 中的 section 名字</td>
<td style="text-align: center;">N/A</td>
</tr>
<tr>
<td style="text-align: center;">Section Header</td>
<td style="text-align: center;">描述目标文件的 section</td>
<td style="text-align: center;">N/A</td>
</tr>
</tbody>
</table>
<p>这里拿具体的例子展示一下, 环境是 x86_64 Linux, 使用
<code>readelf</code> 读 ELF 文件, 删去了一些不重要的输出,
中文为注释。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    func();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> bss;</span><br><span class="line"><span class="type">int</span> arr[<span class="number">1024</span>];</span><br><span class="line"><span class="type">int</span> dx[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c -static test.c -o elf.out</span><br><span class="line">$ readelf -a elf.out</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">    前 16 字节描述的生成该文件的系统信息</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">    ELF 类别</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">    补码, 小端法(第二章)</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">    系统类型和 ABI</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              REL (Relocatable file)</span></span><br><span class="line"><span class="string">    可重定位目标文件</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0</span></span><br><span class="line"><span class="string">  Start of program headers:          0 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          664 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           0 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         0</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         13</span></span><br><span class="line"><span class="string">  Section header string table index: 12</span></span><br><span class="line"><span class="string">    描述各个 section 的起始/大小信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Section Headers:</span></span><br><span class="line"><span class="string">  [Nr] Name              Type             Address           Offset</span></span><br><span class="line"><span class="string">       Size              EntSize          Flags  Link  Info  Align</span></span><br><span class="line"><span class="string">  [ 0]                   NULL             0000000000000000  00000000</span></span><br><span class="line"><span class="string">       0000000000000000  0000000000000000           0     0     0</span></span><br><span class="line"><span class="string">  [ 1] .text             PROGBITS         0000000000000000  00000040</span></span><br><span class="line"><span class="string">       0000000000000011  0000000000000000  AX       0     0     1</span></span><br><span class="line"><span class="string">  [ 2] .rela.text        RELA             0000000000000000  000001f8</span></span><br><span class="line"><span class="string">       0000000000000018  0000000000000018   I      10     1     8</span></span><br><span class="line"><span class="string">  [ 3] .data             PROGBITS         0000000000000000  00000060</span></span><br><span class="line"><span class="string">       0000000000000010  0000000000000000  WA       0     0     16</span></span><br><span class="line"><span class="string">  [ 4] .bss              NOBITS           0000000000000000  00000080</span></span><br><span class="line"><span class="string">       0000000000001004  0000000000000000  WA       0     0     32</span></span><br><span class="line"><span class="string">    [ 5] [ 6] [ 7] [ 8] [ 9] 删去</span></span><br><span class="line"><span class="string">  [10] .symtab           SYMTAB           0000000000000000  00000118</span></span><br><span class="line"><span class="string">       00000000000000c0  0000000000000018          11     4     8</span></span><br><span class="line"><span class="string">  [11] .strtab           STRTAB           0000000000000000  000001d8</span></span><br><span class="line"><span class="string">       000000000000001c  0000000000000000           0     0     1</span></span><br><span class="line"><span class="string">  [12] .shstrtab         STRTAB           0000000000000000  00000228</span></span><br><span class="line"><span class="string">       000000000000006c  0000000000000000           0     0     1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Relocation section &#x27;</span>.rela.text<span class="string">&#x27; at offset 0x1f8 contains 1 entry:</span></span><br><span class="line"><span class="string">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span><br><span class="line"><span class="string">00000000000a  000500000004 R_X86_64_PLT32    0000000000000000 func - 4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Relocation section &#x27;</span>.rela.eh_frame<span class="string">&#x27; at offset 0x210 contains 1 entry:</span></span><br><span class="line"><span class="string">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span><br><span class="line"><span class="string">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span></span><br><span class="line"><span class="string">No processor specific unwind information to decode</span></span><br><span class="line"><span class="string">    重定向条目</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Symbol table &#x27;</span>.symtab<span class="string">&#x27; contains 8 entries:</span></span><br><span class="line"><span class="string">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span></span><br><span class="line"><span class="string">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span></span><br><span class="line"><span class="string">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS test.c</span></span><br><span class="line"><span class="string">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 .text</span></span><br><span class="line"><span class="string">     3: 0000000000001000     4 OBJECT  LOCAL  DEFAULT    4 bss</span></span><br><span class="line"><span class="string">     4: 0000000000000000    17 FUNC    GLOBAL DEFAULT    1 foo</span></span><br><span class="line"><span class="string">     5: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND func</span></span><br><span class="line"><span class="string">     6: 0000000000000000  4096 OBJECT  GLOBAL DEFAULT    4 arr</span></span><br><span class="line"><span class="string">     7: 0000000000000000    16 OBJECT  GLOBAL DEFAULT    3 dx</span></span><br><span class="line"><span class="string">    这里的 UND, ABS 下面会说到</span></span><br><span class="line"><span class="string">      Properties: x86 ISA used:</span></span><br><span class="line"><span class="string">        x86 feature used: x86</span></span><br><span class="line"><span class="string">$ readelf -x .text elf.out</span></span><br><span class="line"><span class="string">Hex dump of section &#x27;</span>.text<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">  0x00000000 554889e5 b8000000 00e80000 0000905d UH.............]</span></span><br><span class="line"><span class="string">  0x00000010 c3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      翻译:</span></span><br><span class="line"><span class="string">    0x00000000:  55              push   rbp</span></span><br><span class="line"><span class="string">    0x00000001:  48 89 e5        mov    rbp, rsp</span></span><br><span class="line"><span class="string">    0x00000004:  b8 00 00 00 00  mov    eax, 0</span></span><br><span class="line"><span class="string">    0x00000009:  e8 00 00 00 00  call   0x0000000e  (这里通常是一个占位符，编译后会被替换)</span></span><br><span class="line"><span class="string">    0x0000000e:  90              nop</span></span><br><span class="line"><span class="string">    0x0000000f:  5d              pop    rbp</span></span><br><span class="line"><span class="string">    0x00000010:  c3              ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -x .data elf.out</span></span><br><span class="line"><span class="string">Hex dump of section &#x27;</span>.data<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">  0x00000000 00000000 01000000 02000000 03000000 ...............</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    不是傻子都能看明白。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>UNDEF, COMMON, ABS 是三个仅存在于可重定位文件中的伪节, 分别表示
<em>当前还未定义的外部符号</em>, <em>未初始化的全局变量</em> 和
<em>不应该被重定位的符号</em></p>
<p>*bss: 鉴于新版 GCC 已经自动开启 <code>-fno-common</code>,
这里不再详细说明 COMMON</p>
</blockquote>
<p>理解了各个节之后, 还需要理解如下定义:</p>
<ul>
<li><p>全局符号:
在某个模块中定义的<strong>非静态</strong>全局变量或函数,
可以被其他模块<strong>引用</strong></p></li>
<li><p>外部符号: 引用的其他模块符号的符号引用</p></li>
<li><p>局部符号: 静态全局变量或静态函数, 不能被其他模块引用</p></li>
</ul>
<p>考虑如何区分相同名字的全局符号:</p>
<ul>
<li>强符号: 函数 或 已初始化的全局变量</li>
<li>弱符号: 未初始化的全局变量或</li>
</ul>
<p>规则是: 有强符号优先解析为强符号, 多个强符号同名报错,
多个弱符号任选一个</p>
<p>这个规则会导致一些麻烦的事情</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> y = <span class="number">15212</span>;</span><br><span class="line"><span class="type">int</span> x = <span class="number">15213</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123; f(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bar.c</span></span><br><span class="line"><span class="type">double</span> x;</span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">()</span> &#123; x = <span class="number">-0.0</span>; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时 <code>x : int</code> 是强符号, 调用 <code>f</code> 时将会使用
<code>x : int</code> 赋值为 <code>-0.0</code><br />
然而栈里是这样排布的 <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| y : 0x601024, 四字节 |</span><br><span class="line">| x : 0x601020, 四字节 |</span><br></pre></td></tr></table></figure>
浮点数字面量<code>-0.0</code>是八字节的, 除了填充 x 的四字节还会填充 y
的四字节导致 y 变化</p>
<p>关于链接器解析符号的过程, E, U, D 集合的部分比较简单不再赘述,
直接翻书即可</p>
<blockquote>
<p>由于新版 GCC 已经默认 <code>fno-common</code>, 这段代码会报错</p>
</blockquote>
<h3 id="重定位">重定位</h3>
<p>重定位的过程也分为两个部分: 1. section 和 符号定义 的重定位 (取得
<code>ADDR(r.symbol)</code>)</p>
<ol start="2" type="1">
<li><p>符号引用的重定位 (<code>R_X86_64_PC32</code>, 或
<code>R_X86_64_32</code> 两种方式)</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个重定位条目如下: </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">long</span> offset;   	<span class="comment">/* Offset of the reference to relocate */</span></span><br><span class="line">	<span class="type">long</span> type: <span class="number">32</span>, 	<span class="comment">/* Relocation type */</span></span><br><span class="line">		symbol: <span class="number">32</span>; <span class="comment">/* Symbol table index */</span> </span><br><span class="line">    <span class="type">long</span> addend;	<span class="comment">/* 这个修正下面会说 */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于一个 section s 和 一个 重定位条目结构体 r</span></span><br><span class="line"><span class="comment">// 获取符号引用的指针</span></span><br><span class="line">refptr = s + r.offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果是绝对重定位 R_X86_64_32, 直接赋值</span></span><br><span class="line">*refptr = ADDR(r.symbol) + addend; <span class="comment">/* addend == 0 */</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 如果是相对重定位 R_X86_64_PC32, 需要补正, 下面会解释</span></span><br><span class="line">*refptr = ADDR(r.symbol) + addend - (ADDR(s) + r.offset) <span class="comment">/* addend == -4 */</span></span><br></pre></td></tr></table></figure></p>
<p>对于相对重定位的补正, 我们举个例子:</p>
<p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x1: callq 0x9</span><br></pre></td></tr></table></figure></p>
<p>注意在重定位前 <code>0x9</code> 的位置通常是个占位符,
这里是说明被调用的代码的位置是 <code>0x9</code></p>
<p><code>callq</code> 机器码的位置是 <code>0x1</code>,
<code>refptr</code> 指向 <code>0x2</code> 的位置,
要修改为相对重定向后的地址</p>
<p>先手动计算一下这个位置应当被替换为的值:</p>
<p>我们知道 call 指令是压 PC 入栈作为返回值 + 跳转到 PC + 参数 的位置,
设我们需要重定位替换的参数为 x</p>
<p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x9 == PC + x</span><br></pre></td></tr></table></figure></p>
<p>因为 <code>callq</code> 在 <code>0x1</code>, 而通常 x86_64
一条指令五个字节(例如 AT&amp;T <code>movl $1, %eax</code> 机器码是
<code>B8 01 00 00 00</code>) 所以当前的 PC 应为
<code>0x1 + 0x5 = 0x6</code></p>
<p>得到 <code>x = 0x3</code>.</p>
<p>那么我们如何通过上面的代码实现这个 <code>0x3</code> 的计算呢?
实际上就是靠 <code>addend</code> 的补正作用</p>
<p>列出一些参数:</p>
<table>
<thead>
<tr>
<th style="text-align: center;">内容</th>
<th style="text-align: center;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>ADDR(r.symbol)</code></td>
<td style="text-align: center;"><code>0x9</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>addend</code></td>
<td style="text-align: center;">待计算</td>
</tr>
<tr>
<td style="text-align: center;"><code>ADDR(s) + r.offset</code></td>
<td style="text-align: center;"><code>0x2</code></td>
</tr>
</tbody>
</table>
<p>之所以是 <code>0x2</code> 而不是 <code>0x1</code> 是因为
<code>ADDR(s) + r.offset</code>
是段起始地址+<strong>重定位条目位置相对的偏移</strong>,
也就是说实际上应该是 <code>callq</code> 那个参数(当前为占位符) 的地址,
这也启发我们知道这个值其实就是 <code>callq</code> 的地址 + 1</p>
<p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x9 = PC + x</span><br><span class="line">*refptr = x </span><br><span class="line">        = 0x9 - PC</span><br><span class="line">        = 0x9 - (ADDR(callq) + 5) </span><br><span class="line">    	= 0x9 - (ADDR(callq) + 1 + 4)</span><br><span class="line">  		= ADDR(r.symbol) - (ADDR(S) + r.offset) - 4 </span><br></pre></td></tr></table></figure></p>
<p>于是得出 <code>addend</code> 实际上为 <span
class="math inline">\(-4\)</span></p>
<p>十六进制写 <span class="math inline">\(\LaTeX\)</span> 太怪了,
就贴了个 plain text</p></li>
</ol>
<h2 id="可执行文件">可执行文件:</h2>
<p>可执行文件无伪节, 无 <code>.rel</code> section.</p>
<p>任何 Linux 可执行文件都是 <code>execve</code>
系统调用通过一段操作系统驻留在主存内的代码 <code>loader</code> 执行的
<code>loader</code> 会试图调用 <code>ctrl.o</code>(这里我怀疑是一个
typo, 应为 <code>crt1.o</code>) 中的 <code>_start</code> 函数,
后者会继续调用 <code>libc.so</code> 中的 <code>__libc_start_main</code>
函数, 最后才会调用到用户的 <code>main</code> 函数.</p>
<p>Linux x86_64 ELF64 下 <code>.text</code> 从 <code>0x400000</code>
开始.</p>
<h2 id="动态链接">动态链接:</h2>
<p>动态链接是运行时将内存段中的符号定义重定位到内存段中的符号引用中,
<code>.interp</code> section记录了链接器的路径</p>
<p>可用 <code>dlopen, dlsym, dlclose, dlerror</code> 来在 C
代码中手动加载动态链接库(.so), 加载符号等</p>
<p>由于共享库在内存中的加载位置不确定(你总不能固定下来位置给某个库然后一些不需要的库也浪费着占位吧),
所以需要位置无关代码(Position Independent Code, PIC. GCC 中 使用
<code>-fpic</code> 调用</p>
<h3 id="pic-数据引用">PIC 数据引用:</h3>
<p>原理: 数据段与代码段之间的距离是位置无关的(固定的), 设为 delta.
在代码段引用数据段的数据的时候, 只需要在数据段开头的 GOT (Global Offset
Table) 里存下符号定义的位置(<code>&amp;sym</code>), 则 delta 就是 PC 和
<code>GOT[i]</code> 的差值. 编译器为 GOT 每一个 8
字节条目生成重定位条目, 代码里随便写符号引用, 编译为可重定位目标文件时
直接引用 <code>PC + delta</code> (即 <code>GOT[i]</code>)</p>
<p>此时我们还需要确保在 GOT 存的 <code>&amp;sym</code> 也是位置无关的,
所以在加载时利用动态链接器重定向每个 GOT[i]
的实际符号定义的位置就行了</p>
<h3 id="pic-函数调用">PIC 函数调用:</h3>
<p>利用 GOT 和 PLT (Procedure Linkage Table, 在代码段) 的协作:</p>
<p>首先介绍一些约定俗成的 PLT 位置值:</p>
<ul>
<li><p><code>PLT[0]</code> 处的代码传参并跳转到动态链接器</p></li>
<li><p><code>PLT[1]</code> 跳 <code>__libc_start_main</code></p></li>
<li><p>剩下的条目用于处理需要调用的位置无关函数</p></li>
</ul>
<p>PIC 的函数调用不会直接重定向到函数地址,
因为不知道动态链接库在内存中加载的具体位置 调用某个函数时,
我们调用这个函数对应的 PLT 条目 <code>func@PLT</code>,
具体流程如下(配合书上的图阅读):</p>
<ol type="1">
<li>代码中 call func@PLT, 压入下一条地址作为返回地址并且跳转到对应的 PLT
条目,</li>
<li>而这个 PLT 条目会先跳到符号的 GOT 条目,</li>
<li>而 GOT 条目初始指向其 PLT 条目的下一条(即顺序执行,
之所以这么来回跳是为了延迟绑定, 绑定后就直接跳到 GOT
对应的实际地址而非继续顺序执行了)</li>
<li>而这个”下一条”就是 <code>push 0x1; jmp *PLT[0];</code>,
<code>0x1</code> 是 <code>addvec</code> 的 ID</li>
<li>而 PLT[0] 干的是: 传入必要的重定位表地址作为参数,
跳转到动态链接器</li>
<li>动态链接器会处理重定位然后绑定对应的 GOT 条目, 然后跳转到 func</li>
<li>func 结束后会从之前的 call 压入的返回地址返回</li>
</ol>
<h2 id="库打桩">库打桩:</h2>
<ul>
<li>编译期打桩: <code>-I.</code> 先找当前目录头文件,
在头文件里打包库函数</li>
<li>链接时打桩: 利用静态符号解析: <code>-Wl,--wrap,malloc</code> 把
malloc 解析为 __wrap_malloc</li>
<li>运行时打桩: 利用动态链接符号解析:
<code>LD_PRELOAD="./xxx.so" ./prog</code></li>
</ul>

    </div>
    
    
      <footer class="post-footer">
        <div class="post-tags">
          <strong>Filed under:</strong>
          
            <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" class="tag">#计算机科学</a>
          
            <a href="/tags/CSAPP-cmu15213/" class="tag">#CSAPP/cmu15213</a>
          
        </div>
      </footer>
    
    
    <div class="post-nav">
      
        <a href="/2025/02/19/CSAPP-2025-02-20/" class="post-nav-prev">
          <span class="nav-label">← Previous Story</span>
          <span class="nav-title">CSAPP3e第六章(存储器层次结构)</span>
        </a>
      
      
      
        <a href="/2025/02/13/23H2-bugs/" class="post-nav-next">
          <span class="nav-label">Next Story →</span>
          <span class="nav-title">更新到 23H2 的 bug</span>
        </a>
      
    </div>
  </article>
  
  
    <aside class="post-sidebar">
  
    <div class="sidebar-toc">
      <h3 class="sidebar-title">Table of Contents</h3>
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E7%AC%AC%E4%B8%83%E7%AB%A0-all"><span class="toc-number">1.</span> <span class="toc-text">链接(第七章 ALL)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">静态链接:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">符号解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.1.2.</span> <span class="toc-text">重定位</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">可执行文件:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">1.3.</span> <span class="toc-text">动态链接:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pic-%E6%95%B0%E6%8D%AE%E5%BC%95%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">PIC 数据引用:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pic-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">PIC 函数调用:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%93%E6%89%93%E6%A1%A9"><span class="toc-number">1.4.</span> <span class="toc-text">库打桩:</span></a></li></ol></li></ol>
      </div>
    </div>
  
  
  
    <div class="sidebar-author">
      <div class="author-avatar avatar-rounded">
        <img src="/images/icon.jpg" alt="Avatar">
      </div>
      <p class="author-name">折鸦夜明け前</p>
    </div>
  
  
  
    <div class="sidebar-social">
      <h3 class="sidebar-title">Follow</h3>
      <ul class="social-links">
        
          <li>
            <a href="https://github.com/amiriox" target="_blank" rel="noopener">GitHub</a>
          </li>
        
          <li>
            <a href="mailto:wumingyun2120@gmail.com" target="_blank" rel="noopener">E-Mail</a>
          </li>
        
          <li>
            <a href="https://www.zhihu.com/people/wu-ming-57-22-24" target="_blank" rel="noopener">Zhihu</a>
          </li>
        
          <li>
            <a href="https://space.bilibili.com/444947789" target="_blank" rel="noopener">Bilibili</a>
          </li>
        
      </ul>
    </div>
  
  
  
    <div class="sidebar-links">
      <h3 class="sidebar-title">友情链接</h3>
      <ul class="friend-links">
        
          <li>
            <a href="https://kawayww.com/" target="_blank" rel="noopener">柳下川的博客</a>
          </li>
        
          <li>
            <a href="https://www.overturn.cn/" target="_blank" rel="noopener">远视台</a>
          </li>
        
      </ul>
    </div>
  
</aside>

  
</div>

    </main>
    
    <footer class="newspaper-footer">
  <div class="footer-divider"></div>
  
  <div class="footer-content">
    <div class="footer-section">
      <h3>折鸦夜明け前</h3>
      <p>Est. 2020</p>
      
        <p class="footer-since">Since 2023</p>
      
    </div>
    
    
    <div class="footer-section">
      <h3>Follow Us</h3>
      <ul class="social-links">
        
          <li><a href="https://github.com/amiriox" target="_blank" rel="noopener">GitHub</a></li>
        
          <li><a href="mailto:wumingyun2120@gmail.com" target="_blank" rel="noopener">E-Mail</a></li>
        
          <li><a href="https://www.zhihu.com/people/wu-ming-57-22-24" target="_blank" rel="noopener">Zhihu</a></li>
        
          <li><a href="https://space.bilibili.com/444947789" target="_blank" rel="noopener">Bilibili</a></li>
        
      </ul>
    </div>
    
    
    
    <div class="footer-section">
      <h3>友情链接</h3>
      <ul class="footer-links">
        
          <li><a href="https://kawayww.com/" target="_blank" rel="noopener">柳下川的博客</a></li>
        
          <li><a href="https://www.overturn.cn/" target="_blank" rel="noopener">远视台</a></li>
        
      </ul>
    </div>
    
    
    <div class="footer-section">
      <h3>Navigation</h3>
      <ul class="footer-nav">
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives">Archives</a></li>
        
          <li><a href="/categories">Categories</a></li>
        
          <li><a href="/tags">Tags</a></li>
        
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>
  </div>
  
  <div class="footer-bottom">
    <p>© 2025 The Daily Amiriox Makinohara. All Rights Reserved.</p>
    <p>
      
        Made with <span class="footer-icon icon-animated" style="color: #8b0000">⚂</span> · 
      
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> · Theme Newspepper
    </p>
  </div>
</footer>

  </div>
  
  <script src="/js/script.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>(草稿)从设备到操作系统: 如何编写驱动 | Amiriox's Storage
</title>


  <meta name="description" content="世界再大 不过是些代价">



  <link rel="icon" href="/images/favicon-32x32.ico">



<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lora:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="/css/style.css">



<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true,
      tags: 'ams'
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Amiriox's Storage" type="application/atom+xml">
</head>
<body>
  <div class="newspaper-wrapper">
    <header class="newspaper-header">
  <div class="header-top">
    <div class="header-edition">Morning Edition</div>
    <div class="header-date">星期一, 二月 2, 2026</div>
    <button class="theme-toggle" aria-label="Toggle dark mode">
      <span class="toggle-sun">☀</span>
      <span class="toggle-moon">☾</span>
    </button>
  </div>
  
  <div class="masthead">
    <h1 class="newspaper-title">
      <a href="/">折鸦夜明け前</a>
    </h1>
    <p class="newspaper-motto">我们的同志在困难的时候，要看到成绩，要看到光明，要提高我们的勇气。</p>
  </div>
  
  <nav class="newspaper-nav">
    <div class="nav-divider"></div>
    <ul class="nav-menu">
      
        <li class="nav-item">
          <a href="/" class="nav-link">Home</a>
        </li>
      
        <li class="nav-item">
          <a href="/archives" class="nav-link">Archives</a>
        </li>
      
        <li class="nav-item">
          <a href="/categories" class="nav-link">Categories</a>
        </li>
      
        <li class="nav-item">
          <a href="/tags" class="nav-link">Tags</a>
        </li>
      
        <li class="nav-item">
          <a href="/about" class="nav-link">About</a>
        </li>
      
    </ul>
    <div class="nav-divider"></div>
  </nav>
</header>

    
    <main class="newspaper-content">
      
<div class="post-container">
  <article class="post-full">
    <header class="post-header">
      <div class="post-meta-top">
        
          <span class="post-category">操作系统</span>
        
        <time datetime="2025-07-26T09:11:50.000Z" class="post-date">
          星期六, 七月 26, 2025</time>
      </div>
      
      <h1 class="post-title">(草稿)从设备到操作系统: 如何编写驱动</h1>
      
      
      
      <div class="post-byline">
        
          <span class="post-author">By 折鸦夜明け前</span>
        
        
          <span class="post-updated">Updated 十二月 31, 2025</span>
        
      </div>
    </header>
    
    <div class="post-divider"></div>
    
    <div class="post-content">
      <h2 id="组件介绍">组件介绍</h2>
<ul>
<li>cpu 内存, 系统总线, pci总线</li>
<li>早期简单设备GPIO直接控制</li>
<li>PCI/USB总线</li>
</ul>
<h2 id="io-相关概念">I/O 相关概念</h2>
<h3 id="io传输方式">I/O传输方式:</h3>
<ul>
<li>PIO(PMIO/MMIO轮询), Interrupt, DMA (中断不一定一定比PIO好,
比如网卡设备)</li>
</ul>
<h3 id="io传输内容">I/O传输内容:</h3>
<ul>
<li>操作系统组件与驱动交互, 驱动与设备交互</li>
<li>驱动传递给设备命令和数据</li>
<li>文件/流/virtio-mmio的共享内存(1, 2略)</li>
</ul>
<span id="more"></span>
<h3 id="io模型">I/O模型:</h3>
<ul>
<li>阻塞</li>
<li>非阻塞</li>
<li>多路复用</li>
<li>信号驱动</li>
<li>异步</li>
</ul>
<h2 id="驱动程序设计">驱动程序设计:</h2>
<ol type="1">
<li>数据结构初始化(VirtIoHeader, 其中包含VirtQueue,
其中包含设备描述符/Avail/Used)</li>
<li>初始化设备, 设定设备状态</li>
<li>中断处理例程</li>
<li>和操作系统组件交互</li>
</ol>
<h3 id="设备的呈现模式与-probe">设备的呈现模式与 probe</h3>
<ol type="1">
<li>x86_64, 个人计算机通常采用 PCI 总线的发现方式</li>
<li>arm/riscv 因为设备多种多样, 采用 device tree,
Bootloader(如SBI)负责将dtb放入寄存器交给操作系统</li>
<li>设备树的 reg 是”总线地址”(对于在 PCI 总线上的设备) 或
直接的物理地址(对于 virtio-mmio 设备), 前者需要 IOMMU 翻译</li>
<li>解析设备树主要是根据不同设备类型分派到不同处理过程,
主要是拿一下地址, 还有相关信息等</li>
</ol>
<h3 id="plic">PLIC:</h3>
<ul>
<li>平台级别中断控制器的意义</li>
<li>传来中断时并不清楚是不是给自己的中断, 所以要检查一下www</li>
</ul>
<h2 id="virtio设备规范">virtio设备规范:</h2>
<p>virtio 之设备描述: 设备特征位与地址空间 virtio 之状态表示: 设备状态域
virtio 只交互机制: 通知+虚拟队列</p>
<h3 id="通知门铃-doorbell">通知(门铃 doorbell):</h3>
<h3 id="虚拟队列-virtqueue">虚拟队列 VirtQueue:</h3>
<ul>
<li>描述符表: 存放每个描述符的位置和 next 指针;
很多驱动传达给设备的信息需要多个描述符组成一个链表(命令+数据+结果)</li>
<li>可用环(Avail vring): 存放驱动程序放进去描述符链表的索引,
表示传递的命令, 通过 kick 机制 (写入特定寄存器) 通知设备有新任务</li>
<li>已用环(Used vring): 设备从可用环中取出描述符链表解析并处理,
然后把填好后的描述符索引放入已用环, 中断一下让驱动程序拿结果</li>
</ul>
<p>在驱动程序操作描述符表, 可用环和通知设备时,
需要设置内存屏障强制控制指令执行顺序,
防止乱序执行导致设备看到错误的信息</p>
<h3 id="virtioheader">VirtIOHeader:</h3>
<p>各种寄存器区域, 除了status 和 features 相关的寄存器,
还有存放虚拟队列索引的寄存器,
以及存放描述符表/可用环/已用环的内存位置的寄存器(分为低32和高32位存,为了兼容性和内存对齐),
以及中断相关的寄存器</p>
<h3 id="初始化设备">初始化设备:</h3>
<p>读取信息, 按照规范设定设备状态, 开辟所需数据结构的dma内存</p>
<h3 id="virtio-gpu">Virtio-GPU:</h3>
<ul>
<li>header, rect, 实际的显示内存载荷, 总体命令的虚拟队列,
光标命令的虚拟队列, 队列本身的内存载荷, 为了方便处理的 send/recv queue
切片(注意生命周期标注, 必须至少和 VirIOGPU 活的一样长)</li>
<li>new 里初始化设备, 分配各种dma内存, 读配置空间</li>
<li>还需要按照规范把实际显存关联到 virtio-gpu 设备上; 主要是发送
ResourceCreate2D 和 ResourceAttackBacking, 然后 SetScanout
把显示资源链接到显示扫描输出上</li>
</ul>
<h3 id="操作系统的任务">操作系统的任务:</h3>
<p>包装 VirtIOGPU 对象, 加引用计数和锁, 操作显存, flush,
暴露系统调用给用户态程序</p>

    </div>
    
    
      <footer class="post-footer">
        <div class="post-tags">
          <strong>Filed under:</strong>
          
            <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" class="tag">#计算机科学</a>
          
            <a href="/tags/QEMU/" class="tag">#QEMU</a>
          
            <a href="/tags/%E8%8D%89%E7%A8%BF/" class="tag">#草稿</a>
          
        </div>
      </footer>
    
    
    <div class="post-nav">
      
        <a href="/2025/08/14/ostep/" class="post-nav-prev">
          <span class="nav-label">← Previous Story</span>
          <span class="nav-title">CPU/内存虚拟化, 调度和并发</span>
        </a>
      
      
      
        <a href="/2025/07/13/freshman2_oscamp_proj_daily/" class="post-nav-next">
          <span class="nav-label">Next Story →</span>
          <span class="nav-title">oscamp 暑期 proj 周纪要</span>
        </a>
      
    </div>
  </article>
  
  
    <aside class="post-sidebar">
  
    <div class="sidebar-toc">
      <h3 class="sidebar-title">Table of Contents</h3>
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">组件介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#io-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">I&#x2F;O 相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#io%E4%BC%A0%E8%BE%93%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">I&#x2F;O传输方式:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#io%E4%BC%A0%E8%BE%93%E5%86%85%E5%AE%B9"><span class="toc-number">2.2.</span> <span class="toc-text">I&#x2F;O传输内容:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#io%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.3.</span> <span class="toc-text">I&#x2F;O模型:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">驱动程序设计:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%9A%84%E5%91%88%E7%8E%B0%E6%A8%A1%E5%BC%8F%E4%B8%8E-probe"><span class="toc-number">3.1.</span> <span class="toc-text">设备的呈现模式与 probe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plic"><span class="toc-number">3.2.</span> <span class="toc-text">PLIC:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virtio%E8%AE%BE%E5%A4%87%E8%A7%84%E8%8C%83"><span class="toc-number">4.</span> <span class="toc-text">virtio设备规范:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E9%97%A8%E9%93%83-doorbell"><span class="toc-number">4.1.</span> <span class="toc-text">通知(门铃 doorbell):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E9%98%9F%E5%88%97-virtqueue"><span class="toc-number">4.2.</span> <span class="toc-text">虚拟队列 VirtQueue:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtioheader"><span class="toc-number">4.3.</span> <span class="toc-text">VirtIOHeader:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%AE%BE%E5%A4%87"><span class="toc-number">4.4.</span> <span class="toc-text">初始化设备:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtio-gpu"><span class="toc-number">4.5.</span> <span class="toc-text">Virtio-GPU:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.6.</span> <span class="toc-text">操作系统的任务:</span></a></li></ol></li></ol>
      </div>
    </div>
  
  
  
    <div class="sidebar-author">
      <div class="author-avatar avatar-rounded">
        <img src="/images/icon.jpg" alt="Avatar">
      </div>
      <p class="author-name">折鸦夜明け前</p>
    </div>
  
  
  
    <div class="sidebar-social">
      <h3 class="sidebar-title">Follow</h3>
      <ul class="social-links">
        
          <li>
            <a href="https://github.com/amiriox" target="_blank" rel="noopener">GitHub</a>
          </li>
        
          <li>
            <a href="mailto:wumingyun2120@gmail.com" target="_blank" rel="noopener">E-Mail</a>
          </li>
        
          <li>
            <a href="https://www.zhihu.com/people/wu-ming-57-22-24" target="_blank" rel="noopener">Zhihu</a>
          </li>
        
          <li>
            <a href="https://space.bilibili.com/444947789" target="_blank" rel="noopener">Bilibili</a>
          </li>
        
      </ul>
    </div>
  
  
  
    <div class="sidebar-links">
      <h3 class="sidebar-title">友情链接</h3>
      <ul class="friend-links">
        
          <li>
            <a href="https://kawayww.com/" target="_blank" rel="noopener">柳下川的博客</a>
          </li>
        
          <li>
            <a href="https://www.overturn.cn/" target="_blank" rel="noopener">远视台</a>
          </li>
        
      </ul>
    </div>
  
</aside>

  
</div>

    </main>
    
    <footer class="newspaper-footer">
  <div class="footer-divider"></div>
  
  <div class="footer-content">
    <div class="footer-section">
      <h3>折鸦夜明け前</h3>
      <p>Est. 2020</p>
      
        <p class="footer-since">Since 2023</p>
      
    </div>
    
    
    <div class="footer-section">
      <h3>Follow Us</h3>
      <ul class="social-links">
        
          <li><a href="https://github.com/amiriox" target="_blank" rel="noopener">GitHub</a></li>
        
          <li><a href="mailto:wumingyun2120@gmail.com" target="_blank" rel="noopener">E-Mail</a></li>
        
          <li><a href="https://www.zhihu.com/people/wu-ming-57-22-24" target="_blank" rel="noopener">Zhihu</a></li>
        
          <li><a href="https://space.bilibili.com/444947789" target="_blank" rel="noopener">Bilibili</a></li>
        
      </ul>
    </div>
    
    
    
    <div class="footer-section">
      <h3>友情链接</h3>
      <ul class="footer-links">
        
          <li><a href="https://kawayww.com/" target="_blank" rel="noopener">柳下川的博客</a></li>
        
          <li><a href="https://www.overturn.cn/" target="_blank" rel="noopener">远视台</a></li>
        
      </ul>
    </div>
    
    
    <div class="footer-section">
      <h3>Navigation</h3>
      <ul class="footer-nav">
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives">Archives</a></li>
        
          <li><a href="/categories">Categories</a></li>
        
          <li><a href="/tags">Tags</a></li>
        
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>
  </div>
  
  <div class="footer-bottom">
    <p>© 2025 The Daily Amiriox Makinohara. All Rights Reserved.</p>
    <p>
      
        Made with <span class="footer-icon icon-animated" style="color: #8b0000">⚂</span> · 
      
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> · Theme Newspepper
    </p>
  </div>
</footer>

  </div>
  
  <script src="/js/script.js"></script>

</body>
</html>
